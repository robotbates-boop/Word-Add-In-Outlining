/* global Office */

Office.onReady(() => {
  const statusEl = document.getElementById("status");
  const setStatus = (m) => { if (statusEl) statusEl.textContent = m; };

  setStatus("Ready.");

  document.querySelectorAll("button[data-module]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const path = btn.getAttribute("data-module");
      setStatus(`Loading: ${path}`);

      try {
        // Load the script and call window.WordToolkit.runModule(...)
        await loadScript(path);

        if (!window.WordToolkit || typeof window.WordToolkit.runModule !== "function") {
          throw new Error(`Module did not register correctly: ${path}`);
        }

        setStatus(`Running: ${path}`);
        await window.WordToolkit.runModule({ setStatus });
        setStatus(`Done: ${path}`);
      } catch (e) {
        setStatus("ERROR: " + String(e?.message || e));
      }
    });
  });
});

function loadScript(src) {
  return new Promise((resolve, reject) => {
    // Cache-bust so updates are picked up
    const url = `${src}?v=${Date.now()}`;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error(`Failed to load ${src}`));
    document.head.appendChild(s);
  });
}
